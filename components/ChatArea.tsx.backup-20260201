
import React, { useRef, useEffect, useState, useMemo } from 'react';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import mermaid from 'mermaid';
import LZString from 'lz-string';
import { Message, LoadingState, AppMode } from '../types';
import { WorkflowState, WorkflowStage } from '../types/workflow';
import {
    SendIcon, PaperclipIcon, FileIcon, UserIcon, RobotIcon, StopIcon, CopyIcon,
    CheckIcon, ArrowUpIcon, CloseIcon, DownloadIcon, LoaderIcon, ShareIcon,
    CheckCircleIcon, CircleIcon, LinkIcon, ShareSquareIcon, UploadIcon
} from './Icons';
import { API_BASE_URL as DIFY_API_BASE_URL } from '../config';
const BACKEND_API_URL = (import.meta.env as any).VITE_API_URL || 'http://localhost:3001/api';
import { renderSupplierBookmarks, containsSupplierInfo } from '../utils/supplierParser';
import { renderProductBookmarks, containsProductInfo } from '../utils/productParser';
import { extractRequirementListWithCategory, generateRequirementListExcelWithTemplate, extractRequirementListWithSelectedCategory, parseUploadedRequirementExcel } from '../services/siliconflowAPI';
import Avatar from './Avatar';
import UserAvatar from './UserAvatar';
import WorkflowNavigation from './WorkflowNavigation';
import FeedbackButtons from './FeedbackButtons';

interface ChatAreaProps {
  messages: Message[];
  isLoading: LoadingState;
  onSend: (text: string, files: File[]) => void;
  onCancel?: () => void;
  placeholder?: string;
  emptyState?: {
      title: string;
      description: string;
  };
  readOnly?: boolean;
  currentNodeName?: string | null;
  conversationId?: string; // æ·»åŠ  conversationId ç”¨äºä¾›åº”å•†æ”¶è—
  workflowState?: WorkflowState; // å·¥ä½œæµçŠ¶æ€
  onStageTransition?: (aiResponse: string) => boolean; // æ£€æŸ¥é˜¶æ®µè½¬æ¢
  updateStageData?: (data: any) => void; // æ›´æ–°é˜¶æ®µæ•°æ®
  onSupplierFavorited?: () => void; // ä¾›åº”å•†æ”¶è—åçš„å›è°ƒ
  onProductBookmarked?: () => void; // å•†å“å¿ƒæ„¿å•åçš„å›è°ƒ
  userId?: string; // ç”¨æˆ·IDï¼Œç”¨äºå•†å“å¿ƒæ„¿å•
  user?: User | null; // å½“å‰ç”¨æˆ·ä¿¡æ¯
  mode?: AppMode; // ä½¿ç”¨ AppMode ç±»å‹
  onNavigateToStage?: (stage: WorkflowStage) => void; // æ‰‹åŠ¨åˆ‡æ¢é˜¶æ®µ
}

const fixUrl = (url: string) => {
    if (!url) return '';
    const toolsPathIndex = url.indexOf('/files/tools/');
    if (toolsPathIndex !== -1) {
        return `${DIFY_API_BASE_URL}${url.substring(toolsPathIndex)}`;
    }
    if (url.startsWith('http')) return url;
    if (url.startsWith('files/tools/')) return `${DIFY_API_BASE_URL}/${url}`;
    return url;
}

const cleanDSML = (text: string) => {
    if (!text) return "";
    let cleaned = text;
    // Remove DSML block and tags
    const blockRegex = /<\s*\|\s*DSML\s*\|\s*function_calls\s*>[\s\S]*?(?:<\/\s*\|\s*DSML\s*\|\s*function_calls\s*>|$)/gi;
    cleaned = cleaned.replace(blockRegex, '');
    const tagRegex = /<\/?\s*\|\s*DSML\s*\|[^>]*>/gi;
    cleaned = cleaned.replace(tagRegex, '');
    return cleaned; 
};

const MermaidDiagram: React.FC<{ code: string }> = ({ code }) => {
    const [svg, setSvg] = useState('');
    const [error, setError] = useState(false);
    const id = useRef(`mermaid-${Math.random().toString(36).substr(2, 9)}`).current;

    useEffect(() => {
        try {
            mermaid.initialize({ startOnLoad: false, theme: 'default', securityLevel: 'loose' });
        } catch (e) {}
        const renderDiagram = async () => {
            if (!code || !code.trim()) return;
            try {
                const cleanCode = code.replace(/^(```mermaid\s*)/i, '').replace(/^(```\s*)/, '').replace(/(```\s*)$/, '').trim();
                const { svg } = await mermaid.render(id, cleanCode);
                setSvg(svg);
                setError(false);
            } catch (e) {
                setError(true);
            }
        };
        renderDiagram();
    }, [code, id]);

    if (error) return <div className="my-2 p-3 bg-red-50 border border-red-100 rounded text-xs font-mono text-red-600">æµç¨‹å›¾æ¸²æŸ“å¤±è´¥</div>;
    return <div className="my-4 flex justify-center overflow-x-auto bg-white p-4 rounded-lg border border-slate-100 min-h-[100px]" dangerouslySetInnerHTML={{ __html: svg }} />;
};

const FileCard: React.FC<{ name: string; url?: string; size?: number; type?: string; onClickDownload?: () => void }> = ({ name, url, size, type, onClickDownload }) => (
    <div className="flex items-center gap-3 p-3 bg-slate-50 border border-slate-200 rounded-xl max-w-sm mt-2 hover:bg-slate-100 transition-colors">
        <div className="w-10 h-10 bg-white rounded-lg flex items-center justify-center border border-slate-100 shadow-sm text-blue-600">
            <FileIcon className="w-5 h-5" />
        </div>
        <div className="flex-1 min-w-0">
            <p className="text-sm font-medium text-slate-700 truncate" title={name}>{name}</p>
            {size ? <p className="text-xs text-slate-400">{(size / 1024).toFixed(1)} KB</p> : <p className="text-xs text-slate-400">{type || 'File'}</p>}
        </div>
        {onClickDownload && (
            <button onClick={onClickDownload} className="p-2 text-slate-400 hover:text-blue-600 rounded-lg hover:bg-white transition-all"><DownloadIcon className="w-5 h-5" /></button>
        )}
    </div>
);

const ChatArea: React.FC<ChatAreaProps> = ({
    messages, isLoading, onSend, onCancel, placeholder, emptyState, readOnly, currentNodeName, conversationId,
    workflowState, onStageTransition, updateStageData, onSupplierFavorited, onProductBookmarked, userId, user, mode, onNavigateToStage
}) => {
  const [inputText, setInputText] = useState('');
  const [selectedFiles, setSelectedFiles] = useState<File[]>([]);
  const [copiedId, setCopiedId] = useState<string | null>(null);
  const [showScrollTop, setShowScrollTop] = useState(false);
  const [isSelectionMode, setIsSelectionMode] = useState(false);
  const [selectedMessageIds, setSelectedMessageIds] = useState<Set<string>>(new Set());
  const [showShareModal, setShowShareModal] = useState(false);
  const [generatedLink, setGeneratedLink] = useState('');
  const [copyLinkStatus, setCopyLinkStatus] = useState<'idle' | 'copied'>('idle');
  const [isAutoScroll, setIsAutoScroll] = useState(true);
  const [stageTransitionNotification, setStageTransitionNotification] = useState<string | null>(null);
  const [isExtractingRequirements, setIsExtractingRequirements] = useState(false);
  const [isParsingExcel, setIsParsingExcel] = useState(false);

  const messagesEndRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const excelUploadInputRef = useRef<HTMLInputElement>(null);
  const textareaRef = useRef<HTMLTextAreaElement>(null);
  const scrollContainerRef = useRef<HTMLDivElement>(null);

  const scrollToBottom = (instant = false) => {
    messagesEndRef.current?.scrollIntoView({ behavior: instant ? 'auto' : 'smooth' });
  };

  const handleScroll = () => {
    if (scrollContainerRef.current) {
        const { scrollTop, scrollHeight, clientHeight } = scrollContainerRef.current;
        setShowScrollTop(scrollTop > 300);
        setIsAutoScroll(scrollHeight - scrollTop - clientHeight < 50);
    }
  };

  useEffect(() => {
    if (messages.length > 0) scrollToBottom();
  }, [messages.length]);

  useEffect(() => {
     if (isAutoScroll && isLoading === LoadingState.STREAMING) scrollToBottom(true);
  }, [messages[messages.length - 1]?.content, isAutoScroll, isLoading]);

  useEffect(() => {
    if (textareaRef.current) {
        textareaRef.current.style.height = 'auto';
        textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 120)}px`;
    }
  }, [inputText]);

  // æå–æœ€åä¸€æ¡ AI æ¶ˆæ¯ï¼Œç”¨äºç›‘å¬å†…å®¹å˜åŒ–
  const lastAiMessage = useMemo(() => {
    return [...messages].reverse().find(m => m.role === 'assistant');
  }, [messages]);

  // Monitor AI responses for workflow stage transitions
  useEffect(() => {
    if (!onStageTransition || !workflowState) return;

    // å¿…é¡»æœ‰æœ€åä¸€æ¡ AI æ¶ˆæ¯
    if (!lastAiMessage) return;

    // Only check for transition when AI is done typing (not streaming)
    if (lastAiMessage.isTyping || isLoading === LoadingState.STREAMING) return;

    console.log('[ChatArea] ===== Checking for stage transition =====');
    console.log('[ChatArea] Current workflowState.currentStage:', workflowState.currentStage);
    console.log('[ChatArea] AI content preview:', lastAiMessage.content.substring(0, 100));
    console.log('[ChatArea] Full AI content length:', lastAiMessage.content.length);

    // Check if the AI response triggers a stage transition
    const transitioned = onStageTransition(lastAiMessage.content);

    console.log('[ChatArea] ===== Transition result:', transitioned, '=====');

    if (transitioned) {
      // Import STAGE_CONFIG dynamically to avoid circular dependency
      import('../types/workflow').then(({ STAGE_CONFIG, WorkflowStage }) => {
        // Use the trigger keywords to determine which stage we're in now
        // The checkForStageTransition has already updated the state in the hook
        // We need to get the LATEST state from the hook, not from our closure
        // Since we can't access the setter, we'll use the message content to determine the new stage
        const content = lastAiMessage.content;

        let detectedStage = workflowState.currentStage; // fallback to current

        // Check which trigger keyword appeared in the message
        // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ£€æµ‹æ‰€æœ‰å¯èƒ½çš„è§¦å‘è¯
        if (content.includes('æ±‡æŠ¥ï¼ä¸ºæ‚¨æ‰¾åˆ°ä»¥ä¸‹ä¼˜è´¨ä¾›åº”å•†') ||
            content.includes('ä¼ä¸šé‡‡è´­å¯»æºæŠ¥å‘Š') ||
            content.includes('å·²è¿›å…¥**ä¾›åº”å•†æ”¶è—**')) {
          detectedStage = WorkflowStage.SUPPLIER_FAVORITE;
        } else if (content.includes('å·²è¿›å…¥**æ·±åº¦å¯»æº**') || 
                   content.includes('å¼€å§‹æ·±åº¦å¯»æº') ||
                   content.includes('æ˜¯å¦å¼€å§‹æ·±åº¦å¯»æº')) {
          detectedStage = WorkflowStage.DEEP_SOURCING;
        } else if (content.includes('å·²è¿›å…¥**éœ€æ±‚æ¸…å•**') || 
                   content.includes('ç”Ÿæˆç»“æ„åŒ–éœ€æ±‚æ¸…å•') ||
                   content.includes('æŠ¥å‘Šï¼ä»¥ä¸‹æ˜¯ä¸ºæ‚¨ç”Ÿæˆçš„é‡‡è´­éœ€æ±‚æ¸…å•') ||
                   content.includes('é‡‡è´­éœ€æ±‚æ¸…å•')) {
          detectedStage = WorkflowStage.REQUIREMENT_LIST;
        } else if (content.includes('å·²è¿›å…¥**åˆæ­¥è°ƒç ”**') ||
                   content.includes('å¼€å§‹åˆæ­¥è°ƒç ”') ||
                   content.includes('è°ƒç ”åˆ†æç»“æœ') ||
                   content.includes('åŸºäºä»¥ä¸Šåˆ†æ')) {
          detectedStage = WorkflowStage.PRELIMINARY_SOURCING;
        } else if (content.includes('å·²è¿›å…¥**ä¾›åº”å•†çº¦è°ˆ**')) {
          detectedStage = WorkflowStage.SUPPLIER_INTERVIEW;
        }

        const newStageTitle = STAGE_CONFIG[detectedStage].title;
        console.log('[ChatArea] Stage transition detected!');
        console.log('[ChatArea] New stage title:', newStageTitle);
        console.log('[ChatArea] Detected stage enum:', detectedStage);
        setStageTransitionNotification(newStageTitle);

        // Auto-hide notification after 3 seconds
        setTimeout(() => {
          setStageTransitionNotification(null);
        }, 3000);
      });
    }
  }, [lastAiMessage?.content, lastAiMessage?.isTyping, isLoading, onStageTransition, workflowState]);

  const toggleSelectionMode = () => {
      setIsSelectionMode(!isSelectionMode);
      setSelectedMessageIds(new Set());
      setGeneratedLink('');
  };

  const toggleMessageSelection = (id: string) => {
      const newSet = new Set(selectedMessageIds);
      if (newSet.has(id)) newSet.delete(id);
      else newSet.add(id);
      setSelectedMessageIds(newSet);
  };

  const handleGenerateLink = () => {
      if (selectedMessageIds.size === 0) return;
      const selectedMsgs = messages.filter(m => selectedMessageIds.has(m.id));
      const payload = selectedMsgs.map(m => ({
          r: m.role,
          c: cleanDSML(m.content),
          f: m.files ? m.files.map(f => ({ n: f.name, s: f.size })) : [],
          g: (m as any).generated_files
      }));
      const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(payload));
      setGeneratedLink(`${window.location.origin}/?share_data=${compressed}`);
      setShowShareModal(true);
  };

  const copyShareLink = async () => {
      await navigator.clipboard.writeText(generatedLink);
      setCopyLinkStatus('copied');
      setTimeout(() => setCopyLinkStatus('idle'), 2000);
  };

  const handleSend = () => {
    const canSend = isLoading === LoadingState.IDLE || isLoading === LoadingState.ERROR;
    if ((!inputText.trim() && selectedFiles.length === 0) || !canSend) return;
    onSend(inputText, selectedFiles);
    setInputText('');
    setSelectedFiles([]);
    setIsAutoScroll(true);
  };

  const handleCopy = async (text: string, id: string) => {
    await navigator.clipboard.writeText(text);
    setCopiedId(id);
    setTimeout(() => setCopiedId(null), 2000);
  };

  const handleDownloadRequirementList = async (messages: Message[], userId: string) => {
    if (!userId) {
      showNotification('è¯·å…ˆç™»å½•', 'error');
      return;
    }

    try {
      setIsExtractingRequirements(true);

      // è·å–é¢„é€‰çš„å“ç±»ä»£ç 
      const selectedCategoryCode = sessionStorage.getItem('selectedCategoryCode');

      if (selectedCategoryCode) {
        // ä½¿ç”¨é¢„é€‰å“ç±»æ¨¡æ¿æå–éœ€æ±‚
        showNotification('æ­£åœ¨ä»å¯¹è¯ä¸­æå–éœ€æ±‚æ¸…å•...', 'success');
        console.log('[handleDownloadRequirementList] Using selected category:', selectedCategoryCode);

        const requirementListData = await extractRequirementListWithSelectedCategory(
          messages.map(m => ({ role: m.role, content: m.content })),
          selectedCategoryCode
        );

        console.log('[handleDownloadRequirementList] Received data:', requirementListData);

        if (!requirementListData) {
          console.error('[handleDownloadRequirementList] No data returned from API');
          showNotification('æå–éœ€æ±‚æ¸…å•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
          return;
        }

        console.log('[handleDownloadRequirementList] Extracted requirements:', requirementListData);

        // ä½¿ç”¨å“ç±»æ¨¡æ¿ç”ŸæˆExcelï¼ˆå³ä½¿éœ€æ±‚åˆ—è¡¨ä¸ºç©ºä¹Ÿå¯ä»¥ç”Ÿæˆç©ºç™½æ¨¡æ¿ï¼‰
        const blob = await generateRequirementListExcelWithTemplate(
          {
            items: requirementListData.items || [],
            projectSummary: requirementListData.projectSummary || { evaluationCriteria: 'æœªä»å¯¹è¯ä¸­æå–åˆ°éœ€æ±‚æ¸…å•' },
          },
          requirementListData.category.code
        );

        // è·å–æ–‡ä»¶å
        const categoryName = requirementListData.category?.name || 'éœ€æ±‚æ¸…å•';
        const fileName = `${categoryName}-${Date.now()}.xlsx`;

        // ä¸‹è½½æ–‡ä»¶
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        const itemCount = (requirementListData.items || []).length;
        showNotification(`æˆåŠŸç”Ÿæˆ${categoryName}ï¼ŒåŒ…å«${itemCount}é¡¹éœ€æ±‚ï¼`, 'success');
      } else {
        // æ²¡æœ‰é¢„é€‰å“ç±»ï¼Œæç¤ºç”¨æˆ·å…ˆé€‰æ‹©å“ç±»
        showNotification('è¯·å…ˆè¿”å›é¦–é¡µé€‰æ‹©é‡‡è´­å“ç±»', 'error');
      }
    } catch (error) {
      console.error('[handleDownloadRequirementList] Error occurred:', error);
      console.error('[handleDownloadRequirementList] Error details:', {
        message: error instanceof Error ? error.message : 'Unknown error',
        stack: error instanceof Error ? error.stack : undefined,
        name: error instanceof Error ? error.name : undefined
      });
      showNotification('ç”Ÿæˆéœ€æ±‚æ¸…å•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    } finally {
      setIsExtractingRequirements(false);
    }
  };

  // å¤„ç†ä¸Šä¼ ä¿®æ”¹åçš„éœ€æ±‚æ¸…å•Excel
  const handleUploadModifiedExcel = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    if (!userId) {
      showNotification('è¯·å…ˆç™»å½•', 'error');
      return;
    }

    try {
      setIsParsingExcel(true);
      showNotification('æ­£åœ¨è§£æéœ€æ±‚æ¸…å•...', 'success');

      console.log('[handleUploadModifiedExcel] Parsing file:', file.name);

      // è°ƒç”¨APIè§£æExcel
      const result = await parseUploadedRequirementExcel(file);

      if (!result || !result.success) {
        showNotification('è§£æéœ€æ±‚æ¸…å•å¤±è´¥', 'error');
        return;
      }

      console.log('[handleUploadModifiedExcel] Parsed result:', result);

      // å°†è§£æåçš„ç»“æ„åŒ–æ–‡æœ¬å‘é€ç»™Difyè¿›è¡Œä¸‹ä¸€è½®å¯¹è¯
      const structuredText = result.data.structuredText;
      const userMessage = `æˆ‘å·²ç»ä¿®æ”¹äº†éœ€æ±‚æ¸…å•ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹æ›´æ–°åçš„éœ€æ±‚ï¼š\n\n${structuredText}\n\nè¯·åŸºäºè¿™äº›éœ€æ±‚å¼€å§‹æ·±åº¦å¯»æºã€‚`;

      // é€šè¿‡onSendå‘é€æ¶ˆæ¯ç»™Dify
      onSend(userMessage, []);

      showNotification(`æˆåŠŸè§£æ${result.data.itemCount}é¡¹éœ€æ±‚ï¼Œæ­£åœ¨å‘é€ç»™å°å¸…...`, 'success');

    } catch (error) {
      console.error('[handleUploadModifiedExcel] Error:', error);
      showNotification('ä¸Šä¼ éœ€æ±‚æ¸…å•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    } finally {
      setIsParsingExcel(false);
      // é‡ç½®æ–‡ä»¶è¾“å…¥
      if (excelUploadInputRef.current) {
        excelUploadInputRef.current.value = '';
      }
    }
  };

  const showNotification = (message: string, type: 'success' | 'error' = 'success') => {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white z-50 ${
      type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 3000);
  };

  return (
    <>
    <div className="flex flex-col h-full bg-gradient-to-b from-slate-50 via-white to-slate-50 relative">
      {/* Subtle grid pattern background */}
      <div className="absolute inset-0 opacity-[0.02] pointer-events-none" style={{
        backgroundImage: `linear-gradient(to right, #94a3b8 1px, transparent 1px), linear-gradient(to bottom, #94a3b8 1px, transparent 1px)`,
        backgroundSize: '40px 40px'
      }}></div>
      {/* Stage Transition Notification */}
      {stageTransitionNotification && (
        <div className="absolute top-4 left-1/2 -translate-x-1/2 z-50 bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-3 animate-fadeIn">
          <div className="w-2 h-2 bg-white rounded-full animate-pulse"></div>
          <span className="font-medium">å·²è¿›å…¥ <span className="font-bold">{stageTransitionNotification}</span> é˜¶æ®µ</span>
        </div>
      )}

      {!readOnly && messages.length > 0 && !isSelectionMode && (
          <button onClick={toggleSelectionMode} className="absolute top-4 right-6 z-10 p-2 bg-white/80 backdrop-blur text-slate-500 hover:text-blue-600 rounded-full border border-slate-200 shadow-sm transition-all"><ShareSquareIcon className="w-5 h-5" /></button>
      )}

      <div ref={scrollContainerRef} onScroll={handleScroll} className={`flex-1 overflow-y-auto p-4 md:p-6 space-y-6 min-h-0 ${isSelectionMode ? 'pb-24' : ''}`}>
        {messages.length === 0 && (
          <div className="h-full flex flex-col items-center justify-center text-slate-400 opacity-80 text-center px-6">
            <div className="w-20 h-20 mb-6 rounded-full bg-gradient-to-br from-blue-50 to-emerald-50 flex items-center justify-center shadow-inner ring-1 ring-slate-100">
              <RobotIcon className="w-10 h-10 text-slate-300" />
            </div>
            <p className="text-xl font-semibold mb-2 text-slate-600">{emptyState?.title}</p>
            <p className="text-sm leading-relaxed max-w-md mx-auto">{emptyState?.description}</p>
          </div>
        )}
        
        {messages.map((msg) => {
          const displayContent = cleanDSML(msg.content);
          const showBubble = displayContent.trim() !== "" || !!msg.isTyping;
          const isSelected = selectedMessageIds.has(msg.id);
          // æ£€æµ‹æ˜¯å¦ä¸ºéœ€æ±‚æ¸…å•è¡¨æ ¼ï¼ˆæ”¯æŒå¤šç§è¡¨æ ¼æ ¼å¼ï¼‰
          const hasStandardTable = displayContent.includes('|') && displayContent.includes('---');
          const hasCustomTable = displayContent.includes('â”‚') || displayContent.includes('â”ƒ'); // å…¨è§’æˆ–åˆ¶è¡¨ç¬¦ç«–çº¿
          const isRequirementList = msg.role === 'assistant' && (hasStandardTable || hasCustomTable);

          return (
            <div key={msg.id} className={`flex items-start gap-3 ${isRequirementList ? 'w-full' : 'max-w-4xl mx-auto'} group relative transition-all duration-300 animate-fadeIn ${isSelectionMode ? 'cursor-pointer' : ''} ${msg.role === 'user' ? 'flex-row-reverse' : ''}`} onClick={() => isSelectionMode && toggleMessageSelection(msg.id)}>
              {isSelectionMode && (
                  <div className="flex items-center self-center shrink-0">
                      {isSelected ? <div className="text-blue-600"><CheckCircleIcon className="w-6 h-6 fill-blue-50" /></div> : <div className="text-slate-300 hover:text-slate-400"><CircleIcon className="w-6 h-6" /></div>}
                  </div>
              )}

              {/* éœ€æ±‚æ¸…å•è¡¨æ ¼æ¶ˆæ¯ä¸æ˜¾ç¤ºå¤´åƒ */}
              {!isRequirementList && (
                <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 shadow-lg transition-all duration-300 ${msg.role === 'user'
                  ? 'bg-white ring-2 ring-blue-100'
                  : mode === 'standard'
                    ? 'bg-gradient-to-br from-emerald-50 to-emerald-100 ring-2 ring-emerald-100'
                    : mode === 'casual'
                      ? 'bg-gradient-to-br from-pink-50 to-pink-100 ring-2 ring-pink-100'
                      : 'bg-slate-100 ring-2 ring-slate-200'
                }`}>
                  {msg.role === 'user' ? (
                    <UserAvatar avatarType={user?.avatar || 'blue'} size="md" />
                  ) : mode === 'standard' ? (
                    <Avatar type="xiaoshuai" size="md" />
                  ) : mode === 'casual' ? (
                    <Avatar type="xiaomei" size="md" />
                  ) : (
                    <RobotIcon className="w-5 h-5 text-slate-600" />
                  )}
                </div>
              )}

              <div className={`flex flex-col ${isRequirementList ? 'w-full flex-1' : 'max-w-[85%] md:max-w-[85%]'} ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                {msg.files && msg.files.length > 0 && (
                   <div className={`flex flex-wrap gap-2 justify-end ${showBubble ? 'mb-2' : ''}`}>
                      {msg.files.map((f, idx) => (
                          <div key={idx} className="flex items-center gap-2 bg-slate-100 border border-slate-200 rounded p-2 text-xs text-slate-700"><FileIcon className="w-3 h-3" /><span className="max-w-[100px] truncate">{f.name}</span></div>
                      ))}
                   </div>
                )}

                {showBubble && (
                  isRequirementList ? (
                    // éœ€æ±‚æ¸…å•è¡¨æ ¼æ¶ˆæ¯ - ä¸ä½¿ç”¨æ°”æ³¡æ ·å¼ï¼Œç›´æ¥æ¸²æŸ“Markdown
                    <div className="w-full">
                      <ReactMarkdown
                          remarkPlugins={[remarkGfm]}
                          components={{
                              a: ({node, ...props}) => <a target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline" {...props} />,
                              table: ({node, ...props}) => <table className="w-full border-collapse text-sm" style={{ backgroundColor: 'transparent' }} {...props} />,
                              thead: ({node, ...props}) => <thead className="border-b-2 border-slate-300" style={{ backgroundColor: 'transparent' }} {...props} />,
                              tbody: ({node, ...props}) => <tbody className="divide-y divide-slate-200" style={{ backgroundColor: 'transparent' }} {...props} />,
                              tr: ({node, ...props}) => <tr className="hover:bg-slate-50" style={{ backgroundColor: 'transparent' }} {...props} />,
                              th: ({node, ...props}) => <th className="px-3 py-2 text-left font-semibold text-slate-700 text-xs border-r border-slate-200 last:border-r-0" style={{ backgroundColor: 'transparent' }} {...props} />,
                              td: ({node, ...props}) => <td className="px-3 py-2 text-slate-600 text-xs border-r border-slate-200 last:border-r-0 align-top" style={{ backgroundColor: 'transparent' }} {...props} />,
                              p: ({node, ...props}) => <p className="mb-2" style={{ backgroundColor: 'transparent' }} {...props} />,
                              code: ({node, ...props}) => {
                                  const { className, children } = props;
                                  if (className?.includes('language-mermaid')) return <MermaidDiagram code={String(children).replace(/\n$/, '')} />;
                                  return <code className={`${className} px-1.5 py-0.5 rounded bg-slate-100 text-slate-800 font-mono text-xs`}{...props}>{children}</code>
                              }
                          }}
                      >
                          {displayContent}
                      </ReactMarkdown>

                      {msg.isTyping && (
                          <div className={`mt-3 inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium animate-pulse ${mode === 'standard'
                            ? 'bg-emerald-50 border border-emerald-200 text-emerald-600'
                            : mode === 'casual'
                              ? 'bg-pink-50 border border-pink-200 text-pink-600'
                              : 'bg-blue-50 border border-blue-100 text-blue-600'
                          }`}>
                              <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 0 12 0h4zm1.529 6.848l-1.758-1.758a8 8 0 111.758-1.758L12 12.529z"></path>
                              </svg>
                              {currentNodeName || 'æ€è€ƒä¸­'}
                          </div>
                      )}

                      {!msg.isTyping && displayContent && !isSelectionMode && (
                         <button onClick={(e) => { e.stopPropagation(); handleCopy(displayContent, msg.id); }} className="absolute top-2 right-2 p-1.5 rounded-lg transition-all duration-200 z-10 text-slate-300 hover:bg-slate-100 hover:text-slate-500 group-hover:opacity-100">
                           {copiedId === msg.id ? <CheckIcon className="w-3.5 h-3.5" /> : <CopyIcon className="w-3.5 h-3.5" />}
                         </button>
                      )}
                    </div>
                  ) : (
                    // æ™®é€šæ¶ˆæ¯ - ä½¿ç”¨æ°”æ³¡æ ·å¼
                    <div className={`relative px-5 py-3.5 rounded-2xl shadow-md leading-relaxed pb-9 min-w-[60px] min-h-[44px] w-full transition-all duration-300 hover:shadow-lg ${msg.role === 'user'
                      ? 'bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-tr-2xl rounded-br-sm'
                      : mode === 'standard'
                        ? 'bg-gradient-to-br from-white to-emerald-50/50 border border-emerald-100 text-slate-700 rounded-tl-2xl rounded-bl-sm'
                        : mode === 'casual'
                          ? 'bg-gradient-to-br from-white to-pink-50/50 border border-pink-100 text-slate-700 rounded-tl-2xl rounded-bl-sm'
                          : 'bg-white border border-slate-200 text-slate-700 rounded-tl-2xl rounded-bl-sm'
                    }`}>
                      <div className={`prose prose-sm max-w-none ${msg.role === 'user' ? 'prose-invert' : 'prose-slate'}`}>
                        <ReactMarkdown
                            remarkPlugins={[remarkGfm]}
                            components={{
                                a: ({node, ...props}) => <a target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline" {...props} />,
                                table: ({node, ...props}) => <table className="w-full border-collapse text-sm" {...props} />,
                                thead: ({node, ...props}) => <thead className="border-b-2 border-slate-300" {...props} />,
                                tbody: ({node, ...props}) => <tbody className="divide-y divide-slate-200" {...props} />,
                                tr: ({node, ...props}) => <tr className="hover:bg-slate-50" {...props} />,
                                th: ({node, ...props}) => <th className="px-3 py-2 text-left font-semibold text-slate-700 text-xs border-r border-slate-200 last:border-r-0" {...props} />,
                                td: ({node, ...props}) => <td className="px-3 py-2 text-slate-600 text-xs border-r border-slate-200 last:border-r-0 align-top" {...props} />,
                                code: ({node, ...props}) => {
                                    const { className, children } = props;
                                    if (className?.includes('language-mermaid')) return <MermaidDiagram code={String(children).replace(/\n$/, '')} />;
                                    return <code className={`${className} px-1.5 py-0.5 rounded bg-slate-100 text-slate-800 font-mono text-xs`}{...props}>{children}</code>
                                }
                            }}
                        >
                            {displayContent}
                        </ReactMarkdown>
                      </div>

                      {msg.isTyping && (
                          <div className={`mt-3 inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium animate-pulse ${mode === 'standard'
                            ? 'bg-emerald-50 border border-emerald-200 text-emerald-600'
                            : mode === 'casual'
                              ? 'bg-pink-50 border border-pink-200 text-pink-600'
                              : 'bg-blue-50 border border-blue-100 text-blue-600'
                          }`}>
                              <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 0 12 0h4zm1.529 6.848l-1.758-1.758a8 8 0 111.758-1.758L12 12.529z"></path>
                              </svg>
                              {currentNodeName || 'æ€è€ƒä¸­'}
                          </div>
                      )}

                      {!msg.isTyping && displayContent && !isSelectionMode && (
                         <button onClick={(e) => { e.stopPropagation(); handleCopy(displayContent, msg.id); }} className={`absolute bottom-2 right-2 p-1.5 rounded-lg transition-all duration-200 z-10 ${msg.role === 'user' ? 'text-blue-200 hover:bg-blue-500 hover:text-white' : 'text-slate-300 hover:bg-slate-100 hover:text-slate-500'} ${copiedId === msg.id ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}>
                         {copiedId === msg.id ? <CheckIcon className="w-3.5 h-3.5" /> : <CopyIcon className="w-3.5 h-3.5" />}
                       </button>
                      )}
                    </div>
                  )
                )}
                
                {msg.role === 'assistant' && msg.generated_files && msg.generated_files.length > 0 && (
                    <div className="mt-2 space-y-2 w-full">
                        {msg.generated_files.map((file, idx) => (
                            <FileCard key={idx} name={file.filename} type={file.extension} size={file.size} onClickDownload={() => window.open(fixUrl(file.url), '_blank')} />
                        ))}
                    </div>
                )}

                {/* ä¾›åº”å•†æ”¶è—æŒ‰é’® - åªåœ¨ AI æ¶ˆæ¯ä¸­æ˜¾ç¤º */}
                {msg.role === 'assistant' && !msg.isTyping && containsSupplierInfo(msg.content) && (
                    <div className="mt-3 w-full">
                        {renderSupplierBookmarks(
                            msg.content,
                            userId,
                            conversationId,
                            onSupplierFavorited
                        )}
                    </div>
                )}

                {/* å•†å“å¿ƒæ„¿å•æŒ‰é’® - åªåœ¨å°ç¾ï¼ˆcasualï¼‰æ¨¡å¼çš„ AI æ¶ˆæ¯ä¸­æ˜¾ç¤º */}
                {mode === 'casual' && msg.role === 'assistant' && !msg.isTyping && userId && (() => {
                  const hasInfo = containsProductInfo(msg.content);
                  console.log('[ChatArea Product Button]', {
                    messageId: msg.id,
                    mode,
                    hasProductInfo: hasInfo
                  });
                  return hasInfo;
                })() && (
                    <div className="mt-3 w-full">
                        {renderProductBookmarks(
                            msg.content,
                            userId,
                            conversationId,
                            onProductBookmarked
                        )}
                    </div>
                )}

                {/* ğŸ†• åé¦ˆæŒ‰é’® - åœ¨æ‰€æœ‰ AI å›å¤åæ˜¾ç¤º */}
                {msg.role === 'assistant' && !msg.isTyping && conversationId && (
                    <FeedbackButtons
                        messageId={msg.id}
                        conversationId={conversationId}
                        onSubmit={async (rating, reason, reasonText) => {
                            // æäº¤åé¦ˆåˆ°åç«¯
                            try {
                                const token = localStorage.getItem('procureai_token');
                                await fetch(`${BACKEND_API_URL}/feedback`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${token}`
                                    },
                                    body: JSON.stringify({
                                        conversationId,
                                        messageId: msg.id,
                                        satisfaction: rating,
                                        reason,
                                        reasonText
                                    })
                                });
                            } catch (error) {
                                console.error('[ChatArea] Failed to submit feedback:', error);
                            }
                        }}
                    />
                )}

                {/* éœ€æ±‚æ¸…å•ä¸‹è½½/ä¸Šä¼ æŒ‰é’® - åªåœ¨éœ€æ±‚æ¸…å•é˜¶æ®µæ˜¾ç¤ºï¼Œä¸”ä»…åœ¨å°å¸…ç•Œé¢ï¼ˆstandardæ¨¡å¼ï¼‰ */}
                {msg.role === 'assistant' && !msg.isTyping && workflowState?.currentStage === WorkflowStage.REQUIREMENT_LIST && mode === 'standard' && (
                    <div className="mt-3 w-full flex flex-wrap gap-2">
                        <button
                            onClick={() => {
                              console.log('[ChatArea Requirement List] Extracting from conversation...');
                              handleDownloadRequirementList(messages, userId || '');
                            }}
                            disabled={isExtractingRequirements || !userId}
                            className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {isExtractingRequirements ? (
                              <>
                                <LoaderIcon className="w-4 h-4 animate-spin" />
                                æ­£åœ¨ç”Ÿæˆ...
                              </>
                            ) : (
                              <>
                                <DownloadIcon className="w-4 h-4" />
                                ä¸‹è½½éœ€æ±‚æ¸…å• Excel
                              </>
                            )}
                        </button>

                        {/* ä¸Šä¼ ä¿®æ”¹åçš„éœ€æ±‚æ¸…å• */}
                        <input
                          type="file"
                          accept=".xlsx,.xls"
                          className="hidden"
                          ref={(el) => {
                            if (!excelUploadInputRef.current) {
                              excelUploadInputRef.current = el;
                            }
                          }}
                          onChange={handleUploadModifiedExcel}
                        />
                        <button
                            onClick={() => excelUploadInputRef.current?.click()}
                            disabled={isParsingExcel || !userId}
                            className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {isParsingExcel ? (
                              <>
                                <LoaderIcon className="w-4 h-4 animate-spin" />
                                æ­£åœ¨è§£æ...
                              </>
                            ) : (
                              <>
                                <UploadIcon className="w-4 h-4" />
                                ä¸Šä¼ ä¿®æ”¹åçš„æ¸…å•
                              </>
                            )}
                        </button>
                    </div>
                )}
              </div>
            </div>
          );
        })}
        <div ref={messagesEndRef} />

        {/* éœ€æ±‚æ¸…å•ç»„ä»¶ - å·²ç¦ç”¨ï¼Œéœ€æ±‚æ¸…å•ä½œä¸ºæ™®é€š Markdown å†…å®¹æ˜¾ç¤º */}
        {/* requirementListData && workflowState?.currentStage === WorkflowStage.REQUIREMENT_LIST && (
          <div className="max-w-4xl mx-auto mt-6 mb-4">
            <RequirementList
              items={requirementListData.items}
              summary={requirementListData.summary}
              onConfirmAndProceed={onConfirmRequirementList}
              onExport={(format) => {
                // TODO: å®ç°å¯¼å‡ºåŠŸèƒ½
                console.log('Export requirement list as:', format);
              }}
            />
          </div>
        ) */}
      </div>
      
      <button onClick={() => scrollContainerRef.current?.scrollTo({ top: 0, behavior: 'smooth' })} className={`absolute bottom-24 right-6 p-3 bg-white border border-slate-200 shadow-xl rounded-full text-slate-500 hover:text-blue-600 transition-all z-50 transform ${showScrollTop ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}><ArrowUpIcon className="w-5 h-5" /></button>

      {isSelectionMode && (
          <div className="absolute bottom-6 left-1/2 -translate-x-1/2 z-50 bg-white border border-slate-200 shadow-2xl rounded-full px-6 py-3 flex items-center gap-4 animate-fadeIn">
              <span className="text-sm font-medium text-slate-600">å·²é€‰æ‹© {selectedMessageIds.size} æ¡</span>
              <div className="h-4 w-px bg-slate-200"></div>
              <button onClick={handleGenerateLink} disabled={selectedMessageIds.size === 0} className="flex items-center gap-2 text-blue-600 hover:text-blue-700 disabled:opacity-50 font-medium text-sm transition-colors"><LinkIcon className="w-4 h-4" />ç”Ÿæˆé“¾æ¥</button>
              <button onClick={toggleSelectionMode} className="text-slate-500 hover:text-slate-800 text-sm transition-colors">å–æ¶ˆ</button>
          </div>
      )}

      {!readOnly && !isSelectionMode && (
          <div className="bg-white border-t border-slate-100 shrink-0 py-4">
            <div className="max-w-4xl mx-auto px-4">
              {/* å·¥ä½œæµé˜¶æ®µå¯¼èˆª - åªåœ¨æ ‡å‡†æ¨¡å¼ï¼ˆå°å¸…ï¼‰ä¸‹æ˜¾ç¤º */}
              {mode === 'standard' && workflowState && onNavigateToStage && messages.length > 0 && (() => {
                const stages = Object.values(WorkflowStage);
                const currentIndex = stages.indexOf(workflowState.currentStage);
                const hasNextStage = currentIndex < stages.length - 1;
                const hasPreviousStage = currentIndex > 0;
                return (
                  <div className="mb-3">
                    <WorkflowNavigation
                      currentStage={workflowState.currentStage}
                      completedStages={workflowState.completedStages}
                      onNextStage={hasNextStage ? () => {
                        onNavigateToStage(stages[currentIndex + 1]);
                      } : undefined}
                      onPreviousStage={hasPreviousStage ? () => {
                        onNavigateToStage(stages[currentIndex - 1]);
                      } : undefined}
                      canGoNext={hasNextStage}
                      canGoPrevious={hasPreviousStage}
                    />
                  </div>
                );
              })()}

              {selectedFiles.length > 0 && (
                <div className="flex flex-wrap gap-2 mb-3">
                  {selectedFiles.map((file, i) => (
                    <div key={i} className="flex items-center gap-2 bg-slate-50 border border-slate-200 text-slate-600 px-3 py-2 rounded-lg text-sm"><span className="max-w-[150px] truncate">{file.name}</span><button onClick={() => setSelectedFiles(prev => prev.filter((_, idx) => idx !== i))} className="hover:text-red-500"><CloseIcon className="w-4 h-4" /></button></div>
                  ))}
                </div>
              )}

              <div className="flex gap-3 items-end bg-gradient-to-br from-slate-50 via-white to-slate-50 border border-slate-200 rounded-2xl p-3 shadow-lg focus-within:ring-2 focus-within:ring-blue-200 focus-within:border-blue-400 transition-all duration-200 hover:border-slate-300">
                <input type="file" multiple className="hidden" ref={fileInputRef} onChange={(e) => e.target.files && setSelectedFiles(prev => [...prev, ...Array.from(e.target.files!)])} />
                <button onClick={() => fileInputRef.current?.click()} className="p-3 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-all duration-200 shrink-0">
                  <PaperclipIcon />
                </button>
                <textarea
                  ref={textareaRef}
                  value={inputText}
                  onChange={(e) => setInputText(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSend())}
                  placeholder={placeholder || "è¯·è¾“å…¥æ¶ˆæ¯..."}
                  rows={1}
                  className="flex-1 bg-transparent border-none outline-none resize-none py-2.5 px-1 text-slate-700 placeholder:text-slate-400 max-h-40 min-h-[44px] leading-relaxed"
                />
                {isLoading === LoadingState.STREAMING || isLoading === LoadingState.UPLOADING ? (
                     <button onClick={onCancel} className="p-3 bg-gradient-to-br from-red-50 to-red-100 text-red-600 rounded-xl hover:from-red-100 hover:to-red-200 transition-all duration-200 shrink-0 shadow-sm hover:shadow-md">
                       <StopIcon />
                     </button>
                ) : (
                    <button
                      onClick={handleSend}
                      disabled={!inputText.trim() && selectedFiles.length === 0}
                      className="p-3 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 disabled:from-slate-200 disabled:to-slate-300 disabled:cursor-not-allowed transition-all duration-200 shrink-0 shadow-md hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0 disabled:transform-none"
                    >
                      <SendIcon />
                    </button>
                )}
              </div>
            </div>
          </div>
      )}

      {showShareModal && (
          <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/30 backdrop-blur-sm">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 space-y-6 animate-fadeIn">
                  <div className="flex justify-between items-center"><h3 className="text-lg font-bold text-slate-800">åˆ†äº«å¯¹è¯å†…å®¹</h3><button onClick={() => setShowShareModal(false)} className="text-slate-400 hover:text-slate-600"><CloseIcon className="w-5 h-5" /></button></div>
                  <div className="space-y-4">
                      <div className="flex flex-col gap-2">
                          <label className="text-sm font-medium text-slate-700">åˆ†äº«é“¾æ¥</label>
                          <div className="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-lg p-2">
                              <div className="flex-1 truncate text-sm text-slate-600 select-all">{generatedLink}</div>
                              <button onClick={copyShareLink} className={`p-2 rounded-md transition-colors shrink-0 ${copyLinkStatus === 'copied' ? 'bg-green-100 text-green-600' : 'bg-white border border-slate-200 hover:text-blue-600'}`}>{copyLinkStatus === 'copied' ? <CheckIcon className="w-4 h-4" /> : <CopyIcon className="w-4 h-4" />}</button>
                          </div>
                      </div>
                      <button onClick={copyShareLink} className="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-xl font-medium transition-colors"><LinkIcon className="w-4 h-4" />å¤åˆ¶é“¾æ¥</button>
                  </div>
              </div>
          </div>
      )}
    </div>
    <style>{`
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fadeIn {
        animation: fadeIn 0.3s ease-out;
      }
    `}</style>
    </>
  );
};

export default ChatArea;
